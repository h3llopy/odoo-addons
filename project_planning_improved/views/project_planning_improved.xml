<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <!--Project-->
        <record model="ir.ui.view" id="project_improved_project_form">
            <field name="name">project_improved_project_form</field>
            <field name="model">project.project</field>
            <field name="inherit_id" ref="project.edit_project"/>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="reference_task_id" context="{'default_project_id': id}"
                           domain="[('project_id', '=', id)]" options="{'no_create': True}"/>
                    <field name="reference_task_end_date"/>
                </xpath>
                <group name="misc" position="before">
                    <field name="reset_scheduling_available" invisible="1"/>
                    <field name="start_auto_planning_available" invisible="1"/>
                    <button name="open_task_planning" string="Open tasks planning" type="object"/>
                    <button name="open_tasks_timeline" type="object" string="Open tasks timeline"/>
                    <button name="reset_scheduling" type="object" string="Reset scheduling"
                            confirm="Are you sure?" attrs="{'invisible': [('reset_scheduling_available', '=', False)]}"/>
                    <button name="start_auto_planning" type="object" string="Start auto-planning"
                            confirm="Are you sure?"  attrs="{'invisible': [('start_auto_planning_available', '=', False)]}" class="oe_highlight"/>
                    <button name="set_tasks_not_tia" type="object" string="Set tasks to 'not taken into account'"
                            confirm="Are you sure?"/>
                </group>
            </field>
        </record>

        <!--Task-->
        <record model="ir.ui.view" id="project_improved_task_tree">
            <field name="name">project_improved_task_tree</field>
            <field name="model">project.task</field>
            <field name="priority" eval="999"/>
            <field name="arch" type="xml">
                <tree string="Tasks planning" editable="top" create="false">
                    <field name="project_id"/>
                    <field name="name"/>
                    <field name="kanban_state"/>
                    <field name="critical_task"/>
                    <field name="objective_duration"/>
                    <field name="taken_into_account"/>
                    <field name="expected_start_date" widget="date"
                           attrs="{'required': [('taken_into_account', '=', True)]}"/>
                    <field name="objective_start_date" widget="date"/>
                    <field name="expected_end_date" widget="date"
                           attrs="{'required': [('taken_into_account', '=', True)]}"/>
                    <field name="objective_end_date" widget="date"/>
                    <field name="parent_task_id" context="{'default_project_id': project_id}"
                           domain="[('project_id', '=', project_id)]"/>
                    <field name="previous_task_ids" widget="many2many_tags" context="{'default_project_id': project_id}"
                           domain="[('project_id', '=', project_id)]"/>
                    <field name="next_task_ids" widget="many2many_tags" context="{'default_project_id': project_id}"
                           domain="[('project_id', '=', project_id)]"/>
                </tree>
            </field>
        </record>

        <record model="ir.ui.view" id="project_improved_task_tree2">
            <field name="name">project_improved_task_tree2</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_tree2"/>
            <field name="arch" type="xml">
                <tree position="inside">
                    <field name="critical_task"/>
                    <field name="objective_duration"/>
                    <field name="parent_task_id"/>
                    <field name="taken_into_account"/>
                    <field name="expected_start_date" widget="date"
                           attrs="{'required': [('taken_into_account', '=', True)]}"/>
                    <field name="objective_start_date" widget="date"/>
                    <field name="expected_end_date" widget="date"
                           attrs="{'required': [('taken_into_account', '=', True)]}"/>
                    <field name="objective_end_date" widget="date"/>
                    <field name="expected_duration"/>
                    <field name="previous_task_ids" widget="many2many_tags"/>
                    <field name="next_task_ids" widget="many2many_tags"/>
                </tree>
            </field>
        </record>

        <record model="ir.actions.server" id="ir_actions_server_update_ready_for_execution">
            <field name="name">Update field 'ready for execution'</field>
            <field name="model_id" ref="project.model_project_task"/>
            <field name="code">
self.update_ready_for_execution(cr, uid, context.get('active_ids'), False, context)
            </field>
        </record>

        <record model="ir.values" id="ir_value_update_ready_for_execution">
            <field name="key">action</field>
            <field name="key2">client_action_multi</field>
            <field name="model">project.task</field>
            <field name="name">Update field 'ready for execution'</field>
            <field name="value" eval="'ir.actions.server,'+str(ir_actions_server_update_ready_for_execution)"/>
        </record>

        <record model="ir.ui.view" id="project_improved_task_search">
            <field name="name">project_improved_task_search</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_search_form"/>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <search position="inside">
                    <filter name="critical_task" string="Critical task" domain="[('critical_task', '=', True)]"/>
                    <separator/>
                    <filter name="taken_into_account" string="Taken into account"
                            domain="[('taken_into_account', '=', True)]"/>
                    <separator/>
                    <filter name="next_month" string="Next month"
                            domain="[('expected_start_date','&lt;=', (context_today() + datetime.timedelta(days=31)).strftime('%%Y-%%m-%%d'))]"/>
                </search>
                <group expand="0" position="inside">
                    <filter string="Parent task" name="group_parent_task" context="{'group_by':'parent_task_id'}"/>
                    <filter name="expected_start_date" string="Expected start date" context="{'group_by':'expected_start_date:day'}"/>
                    <filter name="expected_start_week" string="Expected start week" context="{'group_by':'expected_start_date:week'}"/>
                    <filter name="expected_start_month" string="Expected start month" context="{'group_by':'expected_start_date:month'}"/>
                    <filter name="expected_end_date" string="Expected end date" context="{'group_by':'expected_end_date:day'}"/>
                    <filter name="expected_end_week" string="Expected end week" context="{'group_by':'expected_end_date:week'}"/>
                    <filter name="expected_end_month" string="Expected end month" context="{'group_by':'expected_end_date:month'}"/>
                </group>
            </field>
        </record>

        <record model="ir.ui.view" id="project_improved_task_form">
            <field name="name">project_improved_task_form</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_form2"/>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <field name="stage_id" position="before">
                    <field name="forced_duration_one_day" invisible="1"/>
                    <button name="set_task_on_one_day" type="object" string="Mask in timeline view" confirm="Are you sure? This will set the duration of this task and all its children to one day." attrs="{'invisible': [('forced_duration_one_day', '=', True)]}"/>
                    <button name="unset_task_on_one_day" type="object" string="Display in timeline view" confirm="Are you sure? This will recompute dates for this task and its children from objective durations." attrs="{'invisible': [('forced_duration_one_day', '=', False)]}"/>
                </field>
                <sheet position="attributes">
                    <attribute name="class">oe_form_sheet_full_screen</attribute>
                </sheet>
                <field name="tag_ids" position="after">
                    <field name="critical_task"/>
                    <field name="notify_users_when_dates_change"/>
                </field>
                <field name="planned_hours" position="after">
                    <field name="objective_duration"/>
                </field>
                <xpath expr="//notebook" position="before">
                    <group>
                        <group>
                            <field name="objective_start_date" widget="date"/>
                            <field name="expected_start_date" widget="date"
                                   attrs="{'required': [('taken_into_account', '=', True)]}"/>
                            <field name="conflict"/>
                            <field name="ready_for_execution"/>
                            <field name="allocated_duration"/>
                            <field name="allocated_duration_unit_tasks"/>
                        </group>
                        <group>
                            <field name="objective_end_date" widget="date"/>
                            <field name="expected_end_date" widget="date"
                                   attrs="{'required': [('taken_into_account', '=', True)]}"/>
                            <field name="total_allocated_duration"/>
                            <field name="taken_into_account"/>
                            <field name="expected_duration"/>
                        </group>
                    </group>
                </xpath>
                <notebook position="inside">
                    <page string="Links">
                        <group>
                            <field name="parent_task_id" context="{'default_project_id': project_id}"
                                   domain="[('project_id', '=', project_id)]"/>
                        </group>
                        <separator string="Previous tasks"/>
                        <field name="previous_task_ids" context="{'default_project_id': project_id}"
                               domain="[('project_id', '=', project_id)]"/>
                        <separator string="Next tasks"/>
                        <field name="next_task_ids" context="{'default_project_id': project_id}"
                               domain="[('project_id', '=', project_id)]"/>
                        <separator string="Children tasks"/>
                        <field name="children_task_ids" context="{'default_project_id': project_id}"
                               domain="[('project_id', '=', project_id)]"/>
                    </page>
                </notebook>
            </field>
        </record>

        <record model="ir.ui.view" id="project_improved_task_graph">
            <field name="name">project_improved_task_graph</field>
            <field name="model">project.task</field>
            <field name="inherit_id"/>
            <field name="priority" eval="1"/>
            <field name="arch" type="xml">
                <graph type="line">
                    <field name="expected_start_date" interval="day"/>
                    <field name="allocated_duration" type="measure"/>
                </graph>
            </field>
        </record>

        <record model="ir.actions.act_window" id="act_window_open_task_planning">
            <field name="name">Tasks planning</field>
            <field name="res_model">project.task</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree</field>
            <field name="domain">[]</field>
            <field name="context">{}</field>
            <field name="view_id" ref="project_improved_task_tree"/>
        </record>

        <menuitem id="menu_open_task_planning" name="Tasks planning" action="act_window_open_task_planning"
                  parent="project.menu_project_management" sequence="6"/>

        <record id="project_task_timeline" model="ir.ui.view">
            <field name="name">project_task_timeline</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project_timeline.project_task_timeline"/>
            <field name="type">timeline</field>
            <field name="arch" type="xml">
                <timeline position="attributes">
                    <attribute name="date_start">expected_start_date_display</attribute>
                    <attribute name="date_stop">expected_end_date_display</attribute>
                    <attribute name="colors">#2ecb71: kanban_state == 'done'; #ff5c33: conflict == true; #ec7063: kanban_state == 'blocked'; #fa58d0: taken_into_account == true;</attribute>
                    <attribute name="order_by">parent_task_id</attribute>
                    <attribute name="className">"macro_tache": macro_tache == true;</attribute>
                </timeline>
            </field>
        </record>

        <record model="ir.ui.view" id="project_task_calendar">
            <field name="name">project_task_calendar</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_calendar"/>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <calendar position="attributes">
                    <attribute name="date_start">expected_start_date</attribute>
                    <attribute name="date_delay">expected_end_date</attribute>
                </calendar>
            </field>
        </record>

        <record model="ir.actions.act_window" id="project.action_view_task">
            <field name="domain">[('forced_duration_one_day', '=', False)]</field>
        </record>

    </data>
</openerp>